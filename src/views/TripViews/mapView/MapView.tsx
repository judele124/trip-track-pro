import Map from './Map';
import { useEffect, useMemo } from 'react';
import { useTripContext } from '@/contexts/TripContext';
import { useTripSocket } from '@/contexts/SocketContext';
import StopMarker from './components/Markers/StopMarker';
import GeneralMarker from './components/Markers/GeneralMarker';
import CurrentUserMarker from './components/Markers/CurrentUserMarker';
import UserMarker from './components/UserMarker';
import useCurrentUserLocation from './hooks/useCurrentUserLocation';
import { useAuthContext } from '@/contexts/AuthContext';
import { calculateDistanceOnEarth } from '@/utils/map.functions';
import useToggle from '@/hooks/useToggle';
import { RANGE_STEP_THRESHOLD } from './hooks/useNextStepIndex';
import RouteAndNavigation from './components/RouteAndNavigation';
import useFakeUserLocation from './tests/useFakeUserLocation';
import OtherUserMarker from './components/Markers/OtherUserMarker';

export default function MapView() {
	const { user } = useAuthContext();
	const { trip } = useTripContext();
	const { usersLocations, socket } = useTripSocket();

	const { initialUserLocation, userCurrentLocation } = useCurrentUserLocation({
		onLocationUpdate: (location) => {
			if (!trip || !socket) return;
			socket.emit('updateLocation', trip._id.toString(), location);
		},
	});

	const memoizedTripPoints = useMemo(
		() => trip?.stops.map((stop) => stop.location) || [],
		[trip]
	);

	const memoizedUserToTripPoints = useMemo(
		() =>
			trip && initialUserLocation
				? [initialUserLocation, trip.stops[0].location]
				: [],
		[initialUserLocation, trip]
	);

	const fakePoints = useMemo(() => {
		const arr: number[][] = [
			[34.79588, 32.163374],
			[34.796347, 32.162687],
			[34.796268, 32.16231],
			[34.796092, 32.162226],
			[34.796187, 32.162081],
			[34.796231, 32.162002],
			[34.796174, 32.161981],
			[34.79597, 32.1613],
			[34.795935, 32.161179],
			[34.795848, 32.160892],
			[34.79565, 32.160256],
			[34.795597, 32.160099],
			[34.795266, 32.159065],
			[34.795144, 32.158676],
			[34.795116, 32.158593],
			[34.79551, 32.158501],
			[34.795534, 32.158402],
			[34.795542, 32.158334],
			[34.795547, 32.158292],
			[34.795559, 32.158107],
			[34.79559, 32.157936],
			[34.795595, 32.157914],
			[34.795617, 32.157867],
			[34.795469, 32.157715],
			[34.795585, 32.157673],
			[34.795499, 32.157367],
			[34.795432, 32.157096],
			[34.795299, 32.156701],
			[34.794908, 32.15525],
			[34.794289, 32.153716],
			[34.792641, 32.14866],
			[34.791738, 32.146283],
			[34.790937, 32.144172],
			[34.78954, 32.139648],
			[34.788759, 32.137594],
			[34.788659, 32.137331],
			[34.787609, 32.134566],
			[34.786917, 32.132313],
			[34.78587, 32.129761],
			[34.785227, 32.128105],
			[34.785137, 32.127629],
			[34.784524, 32.125916],
			[34.784, 32.124716],
			[34.783887, 32.124394],
			[34.783919, 32.124013],
			[34.78396, 32.123983],
			[34.784044, 32.123982],
			[34.78411, 32.123972],
			[34.784149, 32.123936],
			[34.784169, 32.123874],
			[34.784173, 32.123817],
			[34.784151, 32.123762],
			[34.784099, 32.123646],
			[34.784081, 32.123553],
			[34.78408, 32.123462],
			[34.784103, 32.123362],
			[34.784043, 32.123336],
			[34.784013, 32.123277],
			[34.783451, 32.122209],
			[34.783419, 32.122155],
			[34.78335, 32.122085],
			[34.7833, 32.122044],
			[34.783254, 32.122],
			[34.783182, 32.12189],
			[34.783106, 32.121804],
			[34.783053, 32.121738],
			[34.783001, 32.121648],
			[34.782954, 32.121546],
			[34.782894, 32.121439],
			[34.782848, 32.121333],
			[34.782822, 32.121269],
			[34.782815, 32.121235],
			[34.782823, 32.121207],
			[34.782847, 32.121182],
			[34.782877, 32.121157],
			[34.782882, 32.121136],
			[34.782873, 32.121097],
			[34.78268, 32.120756],
			[34.782649, 32.120697],
			[34.782548, 32.120507],
			[34.782343, 32.120138],
			[34.782306, 32.120038],
			[34.782283, 32.11991],
			[34.782277, 32.1197],
			[34.782274, 32.119635],
			[34.782249, 32.119442],
			[34.782208, 32.119201],
			[34.782139, 32.118953],
			[34.782007, 32.118637],
			[34.781917, 32.118489],
			[34.781833, 32.118402],
			[34.781739, 32.118307],
			[34.781643, 32.118181],
			[34.781569, 32.11806],
			[34.781514, 32.117908],
			[34.781485, 32.117792],
			[34.781472, 32.117699],
			[34.781469, 32.117484],
			[34.781487, 32.117365],
			[34.781498, 32.117286],
			[34.781499, 32.117266],
			[34.781497, 32.117218],
			[34.781485, 32.117136],
			[34.781464, 32.117025],
			[34.781332, 32.116739],
			[34.78119, 32.1166],
			[34.781072, 32.116505],
			[34.780997, 32.116403],
			[34.780956, 32.116326],
			[34.780925, 32.116197],
			[34.780945, 32.115988],
			[34.780969, 32.115803],
			[34.780933, 32.115662],
			[34.78056, 32.114859],
			[34.780378, 32.114473],
			[34.780263, 32.114036],
			[34.779593, 32.112364],
			[34.779385, 32.11196],
			[34.779149, 32.111527],
			[34.77856, 32.110592],
			[34.778343, 32.110217],
			[34.778056, 32.109555],
			[34.777891, 32.109017],
			[34.777853, 32.108915],
			[34.77779, 32.108814],
			[34.777723, 32.10874],
			[34.777608, 32.108653],
			[34.777545, 32.10861],
			[34.777437, 32.108513],
			[34.777361, 32.108422],
			[34.777277, 32.108319],
			[34.777259, 32.108287],
			[34.777159, 32.108108],
			[34.777101, 32.107934],
			[34.777086, 32.107888],
			[34.777074, 32.10782],
			[34.777066, 32.107756],
			[34.777063, 32.107732],
			[34.777061, 32.107505],
			[34.777058, 32.10734],
			[34.777036, 32.1072],
			[34.77703, 32.107181],
			[34.776991, 32.107047],
			[34.776966, 32.106992],
			[34.776941, 32.106936],
			[34.776879, 32.106835],
			[34.776741, 32.106697],
			[34.776663, 32.106539],
			[34.776609, 32.106418],
			[34.776409, 32.105884],
			[34.776392, 32.10583],
			[34.776326, 32.105612],
			[34.776303, 32.105474],
			[34.776285, 32.105267],
			[34.776288, 32.105184],
			[34.77629, 32.105122],
			[34.776313, 32.104994],
			[34.776362, 32.104746],
			[34.776413, 32.104605],
			[34.77649, 32.104419],
			[34.776579, 32.10426],
			[34.776729, 32.104034],
			[34.776814, 32.103936],
			[34.776843, 32.103902],
			[34.777023, 32.103729],
			[34.77711, 32.103642],
			[34.777182, 32.103564],
			[34.77723, 32.103477],
			[34.777298, 32.103341],
			[34.777432, 32.103009],
			[34.777457, 32.102915],
			[34.777514, 32.102703],
			[34.777526, 32.102583],
			[34.777506, 32.10256],
			[34.777487, 32.102539],
			[34.777481, 32.102532],
			[34.777438, 32.102503],
			[34.777417, 32.10249],
			[34.776393, 32.101833],
			[34.776336, 32.101799],
			[34.776317, 32.101778],
			[34.776315, 32.101751],
			[34.776322, 32.101725],
			[34.776335, 32.101708],
			[34.776538, 32.101457],
			[34.77657, 32.101431],
			[34.776609, 32.101398],
			[34.7767, 32.101356],
			[34.776786, 32.101321],
			[34.776844, 32.101275],
			[34.776877, 32.101225],
			[34.776945, 32.101119],
			[34.776975, 32.101066],
			[34.777161, 32.100736],
			[34.777286, 32.100513],
			[34.777375, 32.100417],
			[34.777481, 32.100346],
			[34.777582, 32.100246],
			[34.777601, 32.100165],
			[34.777589, 32.100112],
			[34.777578, 32.100051],
			[34.777427, 32.099494],
			[34.777346, 32.09932],
			[34.777296, 32.099252],
			[34.777279, 32.099229],
			[34.777266, 32.099211],
			[34.777251, 32.099194],
			[34.777231, 32.099172],
			[34.777196, 32.099089],
			[34.777186, 32.099063],
			[34.777156, 32.098984],
			[34.77712, 32.098875],
			[34.77707, 32.098742],
			[34.77695, 32.098304],
			[34.777051, 32.098161],
			[34.777093, 32.09812],
			[34.777101, 32.097882],
			[34.77715, 32.097579],
			[34.777181, 32.097417],
			[34.777295, 32.097194],
			[34.777247, 32.09708],
			[34.777446, 32.096758],
			[34.777473, 32.096703],
			[34.777514, 32.096657],
			[34.777629, 32.096529],
			[34.777862, 32.096277],
			[34.777958, 32.096195],
			[34.778431, 32.095903],
			[34.778615, 32.09579],
			[34.778664, 32.095766],
			[34.778762, 32.095724],
			[34.778858, 32.095683],
			[34.778879, 32.095675],
			[34.778689, 32.095289],
			[34.778788, 32.095254],
			[34.778901, 32.095228],
			[34.778638, 32.094742],
			[34.778842, 32.094527],
			[34.778965, 32.094417],
			[34.779608, 32.093845],
			[34.779679, 32.093792],
			[34.780579, 32.093182],
			[34.781356, 32.092806],
			[34.781496, 32.092773],
			[34.781353, 32.092018],
			[34.781341, 32.091952],
			[34.781329, 32.09185],
			[34.781316, 32.09179],
			[34.781212, 32.091286],
			[34.781169, 32.091066],
			[34.781061, 32.090521],
			[34.780896, 32.089743],
			[34.780925, 32.08974],
			[34.781544, 32.089647],
			[34.781255, 32.088346],
			[34.781509, 32.088301],
			[34.782201, 32.088174],
			[34.782268, 32.088133],
			[34.782247, 32.088023],
			[34.782066, 32.087042],
			[34.781998, 32.086669],
			[34.781747, 32.085391],
			[34.78174, 32.085355],
			[34.781717, 32.085237],
			[34.781692, 32.085119],
			[34.781571, 32.084534],
			[34.781327, 32.083308],
			[34.781457, 32.0833],
			[34.781497, 32.083297],
			[34.781486, 32.083236],
			[34.781476, 32.083073],
			[34.781429, 32.082228],
			[34.781447, 32.081771],
			[34.78145, 32.081721],
			[34.781458, 32.08154],
			[34.781457, 32.081396],
			[34.781456, 32.081366],
			[34.781426, 32.080642],
			[34.781408, 32.080411],
			[34.781419, 32.080319],
			[34.781424, 32.080179],
			[34.781424, 32.080163],
			[34.781424, 32.080145],
			[34.781403, 32.079602],
			[34.781353, 32.079599],
			[34.78131, 32.079598],
			[34.781249, 32.079544],
			[34.781228, 32.079497],
			[34.781224, 32.07933],
			[34.781205, 32.078809],
			[34.781201, 32.078527],
			[34.781211, 32.078156],
			[34.78124, 32.077676],
			[34.781253, 32.077561],
			[34.781294, 32.077244],
			[34.781457, 32.076253],
			[34.781572, 32.075653],
			[34.781591, 32.075539],
			[34.781672, 32.074862],
			[34.781726, 32.074255],
			[34.781743, 32.073798],
			[34.781754, 32.073598],
			[34.781775, 32.073405],
			[34.78179, 32.072966],
			[34.781835, 32.071747],
			[34.781848, 32.071269],
			[34.781848, 32.071128],
			[34.781967, 32.071086],
			[34.782058, 32.07101],
			[34.782308, 32.070778],
			[34.78245, 32.070586],
			[34.782514, 32.070501],
			[34.782544, 32.070456],
			[34.78258, 32.070399],
			[34.782621, 32.070301],
			[34.78268, 32.070145],
			[34.782763, 32.069921],
			[34.782829, 32.069745],
			[34.782853, 32.069681],
			[34.782876, 32.069621],
			[34.782905, 32.069541],
			[34.782924, 32.069474],
			[34.782964, 32.069304],
			[34.782972, 32.069267],
			[34.783004, 32.06914],
			[34.783107, 32.068711],
			[34.783156, 32.068494],
			[34.78323, 32.068163],
			[34.783259, 32.068034],
			[34.783315, 32.067794],
			[34.783376, 32.067657],
			[34.783434, 32.067407],
			[34.783529, 32.066972],
			[34.783544, 32.066907],
			[34.783655, 32.06641],
			[34.783682, 32.066305],
			[34.783721, 32.066193],
			[34.783773, 32.066111],
			[34.783821, 32.066047],
			[34.783943, 32.066015],
			[34.783844, 32.065916],
			[34.784251, 32.065812],
			[34.784331, 32.065791],
			[34.784281, 32.065647],
			[34.784121, 32.065184],
			[34.784326, 32.065132],
			[34.784307, 32.065077],
			[34.784393, 32.064846],
			[34.784367, 32.064672],
			[34.784224, 32.064652],
			[34.784055, 32.064447],
			[34.783936, 32.064104],
			[34.783755, 32.064045],
			[34.783712, 32.063917],
			[34.783805, 32.063901],
			[34.784223, 32.063798],
			[34.784907, 32.063628],
			[34.785077, 32.063588],
			[34.78526, 32.063532],
			[34.785241, 32.063479],
			[34.785313, 32.063449],
			[34.78537, 32.063414],
			[34.785421, 32.063361],
			[34.785389, 32.063288],
			[34.785356, 32.063233],
			[34.785313, 32.063187],
			[34.785276, 32.063149],
			[34.785246, 32.063111],
			[34.785133, 32.062929],
			[34.785071, 32.062771],
			[34.784978, 32.062535],
			[34.784957, 32.062483],
			[34.784939, 32.062439],
			[34.784815, 32.062024],
			[34.784743, 32.061682],
			[34.784661, 32.061312],
			[34.784525, 32.060698],
			[34.784424, 32.060099],
			[34.784369, 32.059831],
			[34.784302, 32.059574],
			[34.784254, 32.05942],
			[34.784227, 32.05936],
			[34.784198, 32.059274],
			[34.783969, 32.059196],
			[34.783857, 32.059155],
			[34.783757, 32.059135],
			[34.783623, 32.059095],
			[34.783599, 32.059075],
			[34.783581, 32.059055],
			[34.783568, 32.059023],
			[34.783564, 32.058979],
			[34.783568, 32.058926],
			[34.783576, 32.058849],
			[34.783572, 32.058775],
			[34.783564, 32.058716],
			[34.783543, 32.058657],
			[34.783255, 32.057899],
			[34.783063, 32.057272],
			[34.782889, 32.056609],
			[34.782551, 32.055584],
			[34.7825, 32.055536],
			[34.782474, 32.055484],
			[34.782282, 32.054795],
			[34.782235, 32.054646],
			[34.782099, 32.054212],
			[34.782037, 32.054039],
			[34.781948, 32.053881],
			[34.781924, 32.053849],
			[34.78189, 32.053822],
			[34.781859, 32.053805],
			[34.781845, 32.053788],
			[34.781838, 32.05377],
			[34.781835, 32.053749],
			[34.781829, 32.053697],
			[34.781822, 32.053642],
			[34.781767, 32.053315],
			[34.781732, 32.053074],
			[34.781726, 32.052793],
			[34.781744, 32.052052],
			[34.781748, 32.051917],
			[34.781706, 32.05158],
			[34.781688, 32.051501],
			[34.781621, 32.051201],
			[34.781522, 32.050904],
			[34.781466, 32.050697],
			[34.781313, 32.04981],
			[34.7813, 32.049731],
			[34.781196, 32.048977],
			[34.781101, 32.048287],
			[34.781067, 32.048105],
			[34.781021, 32.047827],
			[34.780991, 32.047729],
			[34.780952, 32.047634],
			[34.780848, 32.047397],
			[34.780833, 32.047353],
			[34.780735, 32.047211],
			[34.780727, 32.047181],
			[34.78067, 32.046944],
			[34.780648, 32.046827],
			[34.780647, 32.046781],
			[34.78065, 32.046733],
			[34.780661, 32.046683],
			[34.780633, 32.046509],
			[34.780622, 32.046397],
			[34.780618, 32.04627],
			[34.78062, 32.046194],
			[34.780732, 32.045285],
			[34.780737, 32.045174],
			[34.780781, 32.044796],
			[34.780787, 32.044669],
			[34.780815, 32.044301],
			[34.780788, 32.044076],
			[34.780784, 32.043785],
			[34.780787, 32.043695],
			[34.780744, 32.043527],
			[34.780682, 32.043338],
			[34.780643, 32.04322],
			[34.780688, 32.043207],
			[34.780658, 32.043117],
			[34.780633, 32.043073],
			[34.780614, 32.043038],
			[34.780571, 32.04296],
			[34.780503, 32.042797],
			[34.780425, 32.042704],
			[34.780397, 32.04267],
			[34.780159, 32.042386],
			[34.78012, 32.042343],
			[34.780095, 32.042315],
			[34.780812, 32.041812],
			[34.781082, 32.041656],
			[34.779404, 32.039726],
			[34.778832, 32.039446],
			[34.778573, 32.039325],
			[34.778448, 32.039319],
			[34.77831, 32.039273],
			[34.778199, 32.039224],
			[34.778076, 32.03915],
			[34.778109, 32.039109],
			[34.778106, 32.039079],
			[34.778035, 32.039087],
			[34.777964, 32.039099],
			[34.777944, 32.039021],
			[34.777985, 32.038965],
			[34.778036, 32.038906],
			[34.777972, 32.038824],
			[34.778097, 32.038758],
			[34.779014, 32.038251],
			[34.779122, 32.03819],
			[34.779443, 32.038006],
			[34.780364, 32.037502],
			[34.780618, 32.037381],
			[34.781534, 32.03699],
			[34.782751, 32.036476],
			[34.7854, 32.035407],
			[34.786209, 32.03505],
			[34.788764, 32.033849],
			[34.790695, 32.032921],
			[34.79093, 32.032795],
			[34.791975, 32.032234],
			[34.792094, 32.03216],
			[34.792466, 32.031937],
			[34.793137, 32.031533],
			[34.79429, 32.030793],
			[34.795224, 32.030137],
			[34.795706, 32.029755],
			[34.796889, 32.028856],
			[34.797411, 32.02846],
			[34.797552, 32.028357],
			[34.79762, 32.028308],
			[34.797727, 32.02822],
			[34.797798, 32.028162],
			[34.79814, 32.027891],
			[34.799254, 32.027023],
			[34.800685, 32.025908],
			[34.801477, 32.025234],
			[34.802145, 32.024572],
			[34.802553, 32.024171],
			[34.802765, 32.02397],
			[34.80285, 32.023889],
			[34.802913, 32.023835],
			[34.803278, 32.023521],
			[34.80486, 32.022204],
			[34.80538, 32.021799],
			[34.805915, 32.02126],
			[34.805917, 32.021232],
			[34.805909, 32.021209],
			[34.805894, 32.021185],
			[34.805873, 32.021166],
			[34.805805, 32.021111],
			[34.805861, 32.021043],
			[34.805926, 32.020966],
			[34.807539, 32.019199],
			[34.807741, 32.018981],
			[34.808281, 32.018397],
			[34.80837, 32.018303],
			[34.808553, 32.018093],
			[34.808762, 32.017853],
			[34.809382, 32.017083],
			[34.80997, 32.016307],
			[34.810593, 32.015479],
			[34.811237, 32.014617],
			[34.812017, 32.013513],
			[34.813208, 32.011871],
			[34.814075, 32.010617],
			[34.814743, 32.009633],
			[34.814818, 32.009476],
			[34.815377, 32.008655],
			[34.815788, 32.008129],
			[34.816372, 32.00742],
			[34.817505, 32.005909],
			[34.817631, 32.005743],
			[34.818119, 32.005138],
			[34.818277, 32.004923],
			[34.818534, 32.004614],
			[34.818894, 32.004214],
			[34.81911, 32.003911],
			[34.819506, 32.003353],
			[34.819579, 32.003225],
			[34.819639, 32.003116],
			[34.819686, 32.002981],
			[34.819712, 32.002868],
			[34.819725, 32.002759],
			[34.819735, 32.002329],
			[34.819726, 32.001792],
			[34.819648, 32.000552],
			[34.819633, 32.000403],
			[34.819626, 32.000337],
			[34.819607, 32.000186],
			[34.819579, 32.000037],
			[34.81956, 31.999949],
			[34.819547, 31.999888],
			[34.819515, 31.999777],
			[34.819461, 31.999635],
			[34.819377, 31.99944],
			[34.818931, 31.998437],
			[34.818511, 31.997795],
			[34.81808, 31.997233],
			[34.81737, 31.996591],
			[34.817299, 31.996532],
			[34.816986, 31.996272],
			[34.816208, 31.995626],
			[34.815261, 31.994828],
			[34.815227, 31.994794],
			[34.814654, 31.994172],
			[34.814305, 31.993751],
			[34.813997, 31.99336],
			[34.813895, 31.993215],
			[34.813856, 31.99316],
			[34.813794, 31.993071],
			[34.813593, 31.992785],
			[34.813441, 31.992563],
			[34.813061, 31.992067],
			[34.812718, 31.991521],
			[34.812538, 31.991136],
			[34.812324, 31.990453],
			[34.812048, 31.989365],
			[34.812023, 31.989278],
			[34.811982, 31.98915],
			[34.811354, 31.987217],
			[34.811116, 31.986548],
			[34.810796, 31.985644],
			[34.810711, 31.985428],
			[34.81027, 31.984092],
			[34.810108, 31.983643],
			[34.809641, 31.982363],
			[34.809436, 31.981824],
			[34.809288, 31.981437],
			[34.809129, 31.980831],
			[34.809104, 31.980748],
			[34.809089, 31.980705],
			[34.808889, 31.980176],
			[34.808434, 31.978779],
			[34.807838, 31.976817],
			[34.807821, 31.976764],
			[34.807456, 31.975633],
			[34.80713, 31.974619],
			[34.80677, 31.973461],
			[34.806763, 31.97344],
			[34.80669, 31.973212],
			[34.806501, 31.97258],
			[34.806476, 31.972497],
			[34.806384, 31.972161],
			[34.806355, 31.972031],
			[34.806295, 31.971801],
			[34.806237, 31.971572],
			[34.805976, 31.971142],
			[34.805822, 31.97093],
			[34.805691, 31.970752],
			[34.805572, 31.970603],
			[34.805527, 31.97054],
			[34.805505, 31.970509],
			[34.805248, 31.970213],
			[34.80505, 31.969983],
			[34.804564, 31.969422],
			[34.804516, 31.969368],
			[34.804478, 31.969324],
			[34.804438, 31.969273],
			[34.804377, 31.969197],
			[34.804185, 31.968957],
			[34.80417, 31.968938],
			[34.804158, 31.968923],
			[34.80386, 31.968527],
			[34.803734, 31.968382],
			[34.803682, 31.968309],
			[34.80365, 31.968269],
			[34.80337, 31.967906],
			[34.803255, 31.967735],
			[34.802942, 31.967272],
			[34.802767, 31.966964],
			[34.802699, 31.966789],
			[34.802674, 31.966708],
			[34.802662, 31.96666],
			[34.802658, 31.966508],
			[34.802697, 31.965865],
			[34.802702, 31.965812],
			[34.80271, 31.965721],
			[34.802719, 31.965618],
			[34.802847, 31.964757],
			[34.802924, 31.964096],
			[34.802927, 31.964061],
			[34.802933, 31.964028],
			[34.802934, 31.964006],
			[34.802938, 31.963962],
			[34.802973, 31.96327],
			[34.802981, 31.963133],
			[34.802998, 31.962833],
			[34.803001, 31.962545],
			[34.802998, 31.96226],
			[34.802943, 31.962054],
			[34.802907, 31.961925],
			[34.802828, 31.961457],
			[34.802701, 31.961002],
			[34.802689, 31.960955],
			[34.80268, 31.960921],
			[34.802641, 31.960773],
			[34.802598, 31.960633],
			[34.802578, 31.96056],
			[34.802385, 31.959849],
			[34.802355, 31.959738],
			[34.802257, 31.959376],
			[34.802246, 31.959335],
			[34.802228, 31.959268],
			[34.802193, 31.959118],
			[34.802165, 31.958999],
			[34.802144, 31.958915],
			[34.802134, 31.958872],
			[34.802099, 31.95873],
			[34.802071, 31.958624],
			[34.802027, 31.958391],
			[34.802003, 31.958081],
			[34.802104, 31.957361],
			[34.802144, 31.957015],
			[34.802232, 31.956448],
			[34.802489, 31.95479],
			[34.80252, 31.954455],
			[34.802535, 31.954328],
			[34.80253, 31.954139],
			[34.802529, 31.954098],
			[34.802524, 31.95398],
			[34.80251, 31.953916],
			[34.80247, 31.95372],
			[34.802311, 31.952869],
			[34.802198, 31.95233],
			[34.802158, 31.952096],
			[34.802087, 31.9515],
			[34.802015, 31.950951],
			[34.801999, 31.950827],
			[34.801973, 31.950691],
			[34.802187, 31.950661],
			[34.802315, 31.950645],
			[34.802277, 31.95047],
			[34.802161, 31.949934],
			[34.802118, 31.949574],
			[34.802097, 31.949433],
			[34.802049, 31.949118],
			[34.802025, 31.948994],
			[34.801965, 31.948623],
			[34.801943, 31.948103],
			[34.801984, 31.947922],
			[34.801918, 31.947893],
			[34.80184, 31.947873],
			[34.801777, 31.947617],
			[34.801749, 31.947519],
			[34.801765, 31.947501],
			[34.801795, 31.947472],
			[34.801608, 31.947153],
			[34.801565, 31.946802],
			[34.80154, 31.946645],
			[34.801569, 31.94657],
			[34.801548, 31.946531],
			[34.801532, 31.94649],
			[34.801515, 31.946406],
			[34.801439, 31.945812],
			[34.801346, 31.945265],
			[34.801323, 31.945103],
			[34.801292, 31.944864],
			[34.801139, 31.943843],
			[34.800981, 31.94281],
			[34.800905, 31.942311],
			[34.800814, 31.941732],
			[34.800802, 31.941487],
			[34.800825, 31.941387],
			[34.800774, 31.941328],
			[34.800768, 31.941283],
			[34.800762, 31.941242],
			[34.80075, 31.941151],
			[34.800732, 31.941131],
			[34.800764, 31.941058],
			[34.800711, 31.940974],
			[34.800585, 31.940307],
			[34.800494, 31.939723],
			[34.800408, 31.939137],
			[34.800317, 31.9385],
			[34.800221, 31.937778],
			[34.800183, 31.937114],
			[34.800155, 31.936778],
			[34.800146, 31.936704],
			[34.800102, 31.936662],
			[34.800077, 31.936603],
			[34.799994, 31.936617],
			[34.79982, 31.936638],
			[34.799812, 31.936563],
			[34.7998, 31.936492],
			[34.799736, 31.936115],
			[34.79972, 31.935966],
			[34.799704, 31.935803],
			[34.799681, 31.935445],
			[34.799637, 31.934559],
			[34.79961, 31.933366],
			[34.799599, 31.933167],
			[34.799569, 31.932935],
			[34.79952, 31.93271],
			[34.799431, 31.93233],
			[34.799084, 31.931141],
			[34.798983, 31.930795],
			[34.798838, 31.930326],
			[34.798732, 31.929881],
			[34.79871, 31.929757],
			[34.798678, 31.929567],
			[34.798654, 31.92945],
			[34.798631, 31.929345],
			[34.798595, 31.929188],
			[34.798579, 31.92912],
			[34.79855, 31.929016],
			[34.798536, 31.928967],
			[34.798518, 31.928899],
			[34.798443, 31.928628],
			[34.798404, 31.928504],
			[34.798329, 31.928211],
			[34.798298, 31.928088],
			[34.798218, 31.927777],
			[34.798042, 31.927042],
			[34.798031, 31.926999],
			[34.797981, 31.926797],
			[34.797934, 31.926552],
			[34.797786, 31.9258],
			[34.797765, 31.92569],
			[34.797756, 31.925596],
			[34.797746, 31.925435],
			[34.797742, 31.925298],
			[34.79774, 31.925112],
			[34.797748, 31.924892],
			[34.797751, 31.924794],
			[34.797757, 31.924389],
			[34.797759, 31.924303],
			[34.797764, 31.924184],
			[34.797768, 31.924071],
			[34.797775, 31.923804],
			[34.797825, 31.92301],
			[34.797854, 31.922685],
			[34.797866, 31.922532],
			[34.79788, 31.92238],
			[34.797908, 31.92181],
			[34.797944, 31.921507],
			[34.797969, 31.921343],
			[34.798015, 31.921076],
			[34.798067, 31.920851],
			[34.798105, 31.920701],
			[34.798155, 31.920536],
			[34.79821, 31.920408],
			[34.798273, 31.920259],
			[34.798321, 31.92017],
			[34.798409, 31.920004],
			[34.798441, 31.919943],
			[34.7985, 31.91983],
			[34.798993, 31.918901],
			[34.799345, 31.918239],
			[34.799367, 31.918197],
			[34.799531, 31.917886],
			[34.799597, 31.917761],
			[34.799779, 31.917767],
			[34.799949, 31.917439],
			[34.801382, 31.914612],
			[34.801569, 31.914263],
			[34.802299, 31.912848],
			[34.802778, 31.912015],
			[34.802826, 31.911932],
			[34.802893, 31.91182],
			[34.80295, 31.911733],
			[34.803028, 31.911622],
			[34.803087, 31.911541],
			[34.803184, 31.911416],
			[34.803283, 31.911298],
			[34.804227, 31.910239],
			[34.804336, 31.910109],
			[34.804411, 31.91002],
			[34.804474, 31.909932],
			[34.804513, 31.909873],
			[34.804622, 31.909704],
			[34.804849, 31.909346],
			[34.805009, 31.908996],
			[34.805144, 31.908666],
			[34.805334, 31.908165],
			[34.805444, 31.907855],
			[34.805597, 31.90746],
			[34.805697, 31.907207],
			[34.805782, 31.907014],
			[34.806071, 31.906434],
			[34.806073, 31.906429],
			[34.806116, 31.906325],
			[34.80616, 31.906221],
			[34.806196, 31.906148],
			[34.806262, 31.906165],
			[34.806325, 31.906044],
			[34.806415, 31.905849],
			[34.806488, 31.905687],
			[34.806546, 31.905561],
			[34.806694, 31.905244],
			[34.806841, 31.904959],
			[34.806931, 31.904794],
			[34.807005, 31.904672],
			[34.807098, 31.904561],
			[34.807123, 31.904547],
			[34.807375, 31.904299],
			[34.807602, 31.90407],
			[34.807794, 31.903876],
			[34.80787, 31.903805],
			[34.807919, 31.903779],
			[34.807958, 31.903774],
			[34.807953, 31.903733],
			[34.807955, 31.903703],
			[34.807994, 31.903692],
			[34.808037, 31.90366],
			[34.808077, 31.903625],
			[34.808104, 31.903601],
			[34.808106, 31.903575],
			[34.808198, 31.903447],
			[34.808315, 31.903252],
			[34.808437, 31.902995],
			[34.808479, 31.902924],
			[34.808498, 31.902896],
			[34.808547, 31.902877],
			[34.808565, 31.902846],
			[34.808604, 31.90277],
			[34.808503, 31.902753],
			[34.808667, 31.902481],
			[34.808885, 31.902085],
			[34.808899, 31.902058],
			[34.808934, 31.901991],
			[34.809271, 31.901337],
			[34.809282, 31.901314],
			[34.809305, 31.901266],
			[34.809618, 31.900639],
			[34.809667, 31.900547],
			[34.809694, 31.900497],
			[34.809806, 31.900295],
			[34.809924, 31.900069],
			[34.809982, 31.899958],
			[34.810052, 31.899796],
			[34.81029, 31.899148],
			[34.810329, 31.899043],
			[34.810351, 31.898906],
			[34.810393, 31.898652],
			[34.810504, 31.89834],
			[34.810523, 31.89828],
			[34.810773, 31.897487],
			[34.810794, 31.897396],
			[34.810898, 31.896989],
			[34.811049, 31.896399],
			[34.811206, 31.895784],
			[34.811302, 31.895458],
			[34.811393, 31.895098],
			[34.811553, 31.894659],
			[34.811598, 31.894507],
			[34.811616, 31.894446],
			[34.811639, 31.894376],
			[34.811665, 31.894288],
			[34.811817, 31.893772],
			[34.811899, 31.893325],
			[34.811964, 31.893118],
			[34.812029, 31.892891],
			[34.81214, 31.89251],
			[34.812326, 31.891871],
			[34.812514, 31.891284],
			[34.812534, 31.891221],
			[34.812547, 31.891183],
			[34.812569, 31.891114],
			[34.812585, 31.891065],
			[34.812652, 31.890917],
			[34.812668, 31.890881],
			[34.812711, 31.890796],
			[34.81283, 31.890558],
			[34.812876, 31.890458],
			[34.812922, 31.890357],
			[34.812954, 31.890289],
			[34.813027, 31.890129],
			[34.813068, 31.890013],
			[34.81309, 31.889923],
			[34.813147, 31.889658],
			[34.813229, 31.889279],
			[34.813354, 31.888838],
			[34.813482, 31.88839],
			[34.813514, 31.888292],
			[34.813576, 31.888106],
			[34.813632, 31.887946],
			[34.813696, 31.88778],
			[34.813762, 31.887618],
			[34.813819, 31.88751],
			[34.81393, 31.887328],
			[34.814071, 31.887113],
			[34.814161, 31.886951],
			[34.81423, 31.8868],
			[34.814346, 31.886529],
			[34.814437, 31.886281],
			[34.814505, 31.88611],
			[34.814517, 31.886082],
			[34.814773, 31.885613],
			[34.814831, 31.885537],
			[34.814982, 31.885354],
			[34.815099, 31.885342],
			[34.815148, 31.885351],
			[34.817287, 31.885768],
			[34.817468, 31.885794],
			[34.817732, 31.885843],
			[34.817732, 31.885843],
			[34.818023, 31.884942],
			[34.818205, 31.884387],
			[34.818216, 31.884355],
			[34.818265, 31.884205],
			[34.81832, 31.884037],
			[34.818344, 31.883965],
			[34.818383, 31.883911],
			[34.818428, 31.883851],
			[34.818471, 31.883811],
			[34.818517, 31.883778],
			[34.818547, 31.883763],
			[34.818571, 31.883743],
			[34.818589, 31.883718],
			[34.818611, 31.883708],
			[34.818663, 31.883699],
			[34.818957, 31.883719],
			[34.819415, 31.883743],
			[34.819771, 31.883762],
			[34.820322, 31.883791],
			[34.820385, 31.883804],
			[34.820412, 31.883813],
			[34.820439, 31.883835],
			[34.820463, 31.883866],
		];
		return arr.map(([lon, lat]) => ({ lon, lat }));
	}, [trip]);

	const fakeUserLocation = useFakeUserLocation({
		points: fakePoints,
	});

	const { isOpen: isAtTripRoute, setIsOpen: setIsAtTripRoute } = useToggle();

	useEffect(() => {
		if (!trip || !userCurrentLocation || !trip.stops[0].location) return;
		const distance = calculateDistanceOnEarth(
			[userCurrentLocation.lon, userCurrentLocation.lat],
			[trip.stops[0].location.lon, trip.stops[0].location.lat]
		);

		if (distance < RANGE_STEP_THRESHOLD) {
			setIsAtTripRoute(true);
		}
	}, [userCurrentLocation, trip?.stops]);

	return (
		<div className='page-colors mx-auto h-full max-w-[400px]'>
			<Map>
				{userCurrentLocation && (
					<CurrentUserMarker location={userCurrentLocation} />
				)}
				{usersLocations.map(({ id, location }) => (
					<OtherUserMarker location={location} key={id} />
				))}

				{trip?.stops.map((stop, i) => {
					return (
						<GeneralMarker
							key={`${stop.location.lat}-${stop.location.lon}-${i}`}
							location={stop.location}
						>
							<StopMarker stop={stop} />
						</GeneralMarker>
					);
				})}
				{fakeUserLocation && user && (
					<UserMarker location={fakeUserLocation} user={user} />
				)}

				<RouteAndNavigation
					originalPoints={
						isAtTripRoute ? memoizedTripPoints : memoizedUserToTripPoints
					}
					routeOptions={{
						lineColor: '#02a9fc',
						lineWidth: 5,
						lineOpacity: 0.7,
					}}
					userLocation={fakeUserLocation}
				/>

				{/* trip start point */}
				{!isAtTripRoute && trip && (
					<GeneralMarker location={trip.stops[0].location}>
						<div
							className={`relative flex max-w-60 -translate-y-12 items-center justify-between gap-4 rounded-2xl bg-light p-3 text-dark dark:bg-dark dark:text-light`}
						>
							<p className='text-sm font-semibold'>Trip start point</p>

							<svg
								className='absolute left-1/2 top-full size-5 -translate-x-1/2 fill-light dark:fill-dark'
								width='51'
								height='60'
								viewBox='0 0 51 60'
							>
								<path d='M50.75 0H0.75L27.2806 62L50.75 0Z' />
							</svg>
						</div>
					</GeneralMarker>
				)}
			</Map>
		</div>
	);
}
